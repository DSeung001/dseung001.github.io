{{- /* Comments area start */ -}}
{{- /* to add comments read => https://gohugo.io/content-management/comments/ */ -}}

{{- if (and site.Params.comments (ne .Params.disableComments true)) -}}
    <div class="comments">
        <div class="comments-header">
            <h3>💬 댓글</h3>
        </div>

        <script src="https://giscus.app/client.js"
                data-repo="DSeung001/dseung001.github.io"
                data-repo-id="R_kgDOO9ggNQ"
                data-category="Blog Comments"
                data-category-id="DIC_kwDOO9ggNc4CtfJF"
                data-mapping="pathname"
                data-strict="0"
                data-reactions-enabled="1"
                data-emit-metadata="0"
                data-input-position="top"
                data-theme="light"
                data-lang="ko"
                crossorigin="anonymous"
                async>
        </script>

        <!-- localStorage 기반 완벽한 테마 동기화 스크립트 -->
        <script>
            // PaperMod 테마와 localStorage 동기화된 테마 감지
            function getCurrentTheme() {
                // 1. localStorage에서 사용자 선택 확인 (PaperMod 우선순위)
                const userPreference = localStorage.getItem('pref-theme');
                
                if (userPreference === 'dark') {
                    return 'dark';
                } else if (userPreference === 'light') {
                    return 'light';
                }
                
                // 2. body 클래스 확인 (현재 적용된 상태)
                if (document.body.classList.contains('dark')) {
                    return 'dark';
                }
                
                // 3. 시스템 설정 확인 (기본값)
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    return 'dark';
                }
                
                // 4. 기본값
                return 'light';
            }

            // Giscus 테마 업데이트
            function updateGiscusTheme() {
                const currentTheme = getCurrentTheme();
                const giscusFrame = document.querySelector('iframe[src*="giscus.app"]');
                
                if (giscusFrame) {
                    try {
                        giscusFrame.contentWindow.postMessage({
                            giscus: {
                                setConfig: {
                                    theme: currentTheme
                                }
                            }
                        }, 'https://giscus.app');
                    } catch (error) {
                        // 에러 무시
                    }
                }
            }

            // localStorage 변경 감지
            function setupLocalStorageListener() {
                window.addEventListener('storage', function(e) {
                    if (e.key === 'pref-theme') {
                        setTimeout(updateGiscusTheme, 100);
                    }
                });
            }

            // 테마 변경 감지 및 즉시 적용
            function setupThemeSync() {
                // 1. body 클래스 변경 감지
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            setTimeout(updateGiscusTheme, 50);
                        }
                    });
                });

                observer.observe(document.body, {
                    attributes: true,
                    attributeFilter: ['class']
                });

                // 2. 테마 토글 버튼 클릭 감지
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', function() {
                        setTimeout(updateGiscusTheme, 100);
                    });
                }

                // 3. 시스템 테마 변경 감지
                if (window.matchMedia) {
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
                        setTimeout(updateGiscusTheme, 100);
                    });
                }

                // 4. localStorage 변경 감지
                setupLocalStorageListener();

                // 5. 페이지 로드 시 초기 테마 설정
                setTimeout(updateGiscusTheme, 500);
            }

            // Giscus 로드 완료 감지 및 테마 설정
            function waitForGiscus() {
                const checkInterval = setInterval(function() {
                    const giscusFrame = document.querySelector('iframe[src*="giscus.app"]');
                    if (giscusFrame) {
                        clearInterval(checkInterval);
                        
                        // 테마 동기화 설정
                        setupThemeSync();
                        
                        // 초기 테마 적용
                        setTimeout(updateGiscusTheme, 100);
                    }
                }, 500);
            }

            // 페이지 로드 시 실행
            document.addEventListener('DOMContentLoaded', function() {
                waitForGiscus();
            });
        </script>
    </div>
{{- end -}}

{{- /* Comments area end */ -}} 