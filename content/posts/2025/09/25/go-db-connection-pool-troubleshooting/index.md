---
title: "Go 서비스에서 DB 커넥션 풀 문제와 워커 풀 적용기"
date: 2025-09-25T11:58:05+09:00
categories: [ "Golang", "Database" ]
tags: [ "Go", "DB Connection Pool", "Worker Pool", "Trouble shooting" ]
draft: true
description: "원인을 알 수 없는 DB 커넥션 풀 고갈이 발생할 때 적용 했던 방법 들과 다소 허무한 결말을 담았습니다.."
keywords: [ "Golang", "DB 커넥션 풀", "Connection Pool", "Worker Pool", "Trouble shooting" ]
author: "DSeung001"
aliases: [ "/posts/2025/09/25/go-db-connection-pool-troubleshooting/" ]
---

## 문제 상황
지금 다루고 있는 서비스는 안과의사 PC에서 돌아가는 온프레미스 서비스로 현재 다니고 있는 회사에서 납품한 안과 장비들로 찍은 데이터를 의사들이 쉽게 보고, 관리, 수정하기 위한 일종의 의료 데이터 통합 웹 뷰어입니다.
이 웹 뷰어에 대한 신규 기능 및 유지 보수가 제 주된 업무죠 

해당 글에서 다룰 이슈는 다음과 같습니다.<br/>
장비에서 부터 지속 적으로 데이터를 받으면 데이터베이스가 죽어버린다는 문제가 발생합니다. 어느 정도 비슷한 개수의 진료 데이터를 던지면 어느 순간 죽더군요. 
이는 사용자가 윈도우 서비스를 조작하여 DB를 껏다가 키지 않는 이상 서비스를 다시 살릴 수 없는 문제였습니다. <br/>
다행인 점은 고객이 직접 본 다음에 요청한 VC가 아닌 내부에서 시스템 테스트를 통해 발견되었고 또 해당 장비를 국내에서 많이 안 쓴다는 점이 다행이었죠.

하지만 원인을 알 수 없다는 점은 매우 큰 잠재적 이슈 이기에 해당 이슈에 우선 순위를 높게 두고 분석을 진행 했습니다.
결과적으로 마무리 및 정리까지 대략 5일 정도를 소요했네요 

## 원인 분석
일단 확실한 건 커넥션풀이 죽어 버린다는 것으로 로깅을 통해 커넥션 풀을 실시간으로 탐지할 경우 다음처럼 꾸준히 증가가 되고 있었습니다.

에러 로그 보여주고
어디서 누수가 발생하나?

## 삽질들
- 커넥션 풀 모니터링 코드추가
- 로깅 라이브러리 교체
- 캐싱 기능 추가 및 단위 테스트 
- QueryRow, Exec 버그 발견
- 지저분한 리커버리 패턴 고치기
- replica, primary 이슈를 위한 db 인스턴스 분리 로직 제거 

## 삽질의 결과
- 캐싱을 통한 동일 진료 기준 50개 이상 줄어든 db 인스턴스 접근
- 좀더 클린해진 recovery 패턴
- 안정화된 로깅 기능 

## 배운점
- 커넥션 풀에 대한 이해, 반환안되는건 하자가 있는 거지
- 라이브러리 스타 수는 어느 정도 연관이 있다
- 캐싱 기능 추가